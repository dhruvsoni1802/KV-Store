- name: Setup Gateway Server
  hosts: gateway
  become: yes
  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Copy gateway Dockerfile
      copy:
        src: ../../gateway/Dockerfile
        dest: /opt/gateway/

    - name: Copy gateway files
      copy:
        src: ../../gateway/
        dest: /opt/gateway/gateway/

    - name: Copy requirements
      copy:
        src: ../../requirements.txt
        dest: /opt/gateway/

    - name: Build gateway image
      docker_image:
        name: kv-gateway
        build:
          path: /opt/gateway
        source: build

    - name: Debug backend servers list
      debug:
        msg: "Backend servers will be: {{ groups['servers'] | map('extract', hostvars, 'ansible_host') | list }}"

    - name: Set backend servers variable
      set_fact:
        backend_servers_list: "{{ groups['servers'] | map('extract', hostvars, 'ansible_host') | list }}"

    - name: Build backend servers string
      set_fact:
        backend_servers_string: "{{ backend_servers_list | map('regex_replace', '^(.*)$', '\\1:8080') | join(',') }}"

    - name: Debug final backend servers string
      debug:
        msg: "Final BACKEND_SERVERS will be: {{ backend_servers_string }}"

    - name: Run gateway container
      docker_container:
        name: kv-gateway
        image: kv-gateway
        ports:
          - "8000:8000"
        env:
          BACKEND_SERVERS: "{{ backend_servers_string }}"
        restart_policy: unless-stopped

- name: Setup Backend Servers
  hosts: servers
  become: yes
  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Copy server Dockerfile
      copy:
        src: ../../server/Dockerfile
        dest: /opt/server/

    - name: Copy server files
      copy:
        src: ../../server/
        dest: /opt/server/server/

    - name: Copy requirements
      copy:
        src: ../../requirements.txt
        dest: /opt/server/

    - name: Create data directory
      file:
        path: /opt/server/data
        state: directory

    - name: Build server image
      docker_image:
        name: kv-server
        build:
          path: /opt/server
        source: build

    - name: Run server container
      docker_container:
        name: kv-server
        image: kv-server
        ports:
          - "8080:8080"
        volumes:
          - /opt/server/data:/app/data
        restart_policy: unless-stopped
    
    - name: Install UFW
      apt:
        name: ufw
        state: present
        update_cache: yes

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

    - name: Block external access to server port
      ufw:
        rule: deny
        port: '8080'
        src: '0.0.0.0/0'
        
    - name: Allow gateway access to servers
      ufw:
        rule: allow
        port: '8080'
        src: "{{ hostvars[groups['gateway'][0]]['ansible_host'] }}"